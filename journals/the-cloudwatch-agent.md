# The CloudWatch Agent

When you launch an EC2 instance, whether Linux or Windows, CloudWatch will provide metrics related to the instance, such as CPU, network, and disk metrics, by default.

You can view the automatic dashboard generated by AWS CloudWatch by navigating to `CloudWatch –> Dashboard –> Automatic Dashboard –> EC2`. This should display the default AWS vended metrics provided by CloudWatch

Building upon the default vended metrics provided by AWS, there are certain metrics that are only visible to the guest operating system, such as memory metrics and page file utilization. In some cases, you also need to monitor application-level metrics, `Operating System (OS)` logs, or application logs. You can start monitoring these additional levels of detail by utilizing the `unified CloudWatch agent`.

- The unified CloudWatch agent: https://github.com/aws/amazon-cloudwatch-agent

- Agent download link: https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/download-cloudwatch-agent-commandline.html

You can gather the OS metrics and log files from an EC2 instance using the CloudWatch agent. Additionally, you can also enable the Statsd and Collectd protocols, and the procstat plugin to gather application metrics, network metrics, and individual process level metrics respectively, and send them to the CloudWatch metrics namespace.

## Deployment and configuration of the CloudWatch agent on Windows EC2 instance to gather custom metrics and logs

Once you install the unified CloudWatch agent, there are three main components that will provide the required functionality in a Windows instance. The CloudWatch agent installation creates our `Windows Service` that reads the given `Configuration File` and sends the data to the `Amazon CloudWatch` service

You can install the CloudWatch agent in two different ways:

1. Manual installation
2. Automated installation

To build a Windows EC2 instance along with the `Internet Information Services (IIS)` web server. The prerequisites are as follows:

- Set up an EC2 Windows instance with the IIS web server. To set up the EC2 Windows instance, follow the instructions at https://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/EC2_GetStarted.html.

- As we launch the EC2 instance, we will use `User data` to install the IIS web server. Let’s configure the security group to allow port 80 to allow http requests, along with `Remote Desktop Protocol (RDP)` port `3389`, for the EC2 instance to allow the web application to be accessible from the internet. This will allow you to generate user access logs and capture them using the CloudWatch agent when you browse the web application.

- To install the IIS web server, copy the following script to `User data`:

```sh
<powershell>
Install-WindowsFeature -name Web-Server -IncludeManagementTools
</powershell>
```

### Manual installation and configuration of the CloudWatch agent

1. **Set up IAM role**: Create the IAM role and attach the IAM role to an EC2 instance.

The IAM role provides the permission to publish the custom metrics gathered by the agent to the CloudWatch metrics and logs service

- Let’s go ahead and create a new IAM role named `CWAgentAdminRole` with `CloudWatchAgentAdminPolicy`.

Note:
We are using a more privileged policy, `CloudWatchAgentAdminPolicy`, as we are looking to store the configuration file generated in the AWS SSM Parameter Store. `CloudWatchAgentServerPolicy` will be sufficient to gather metrics using the CloudWatch agent and store them in the CloudWatch service.

- Input IAM in the search engine, then select the `IAM` service and navigate to it

- Next, you will select `Roles` | `Create role` | `Select Trusted Entity` | `AWS service` | `Use case` | `EC2`, and select `Next`

- Under `Add permissions`, search for and select `CloudWatchAgentAdminPolicy` and select `Next`

- Provide the `Role name` as `CWAgentAdminRole` and click on the `Create Role` button

- Next, attach the newly created role to the EC2 instance. By attaching the IAM role to the E2 instance, we grant it the required permission to publish CloudWatch metrics and also save the configuration file in Parameter Store in AWS Systems Manager

- Right-click on the instance created, then navigate to `Security`, and select `Modify IAM role`

- From the dropdown, select the role named `CWAgentAdminRole` and click `Save`


2. **Download and install the agent**: Download the CloudWatch agent from S3 or GitHub and install it on the EC2 instance.

Download the agent files from the S3 location provided by AWS that contains the CloudWatch agent source files. This can be done using either the browser or PowerShell. We will use PowerShell for the installation and configuration.

Log in to the Windows EC2 instance created as a part of the prerequisites and download the CloudWatch Agent installation package to the user’s desktop following these steps:

- Make sure to open PowerShell in `Administrator` mode and run the following command to download the unified CloudWatch agent

```sh
Invoke-WebRequest -Uri https://amazoncloudwatch-agent.s3.amazonaws.com/windows/amd64/latest/amazon-cloudwatch-agent.msi -OutFile $env:USERPROFILE\Desktop\amazon-cloudwatch-agent.msi
```

> Documentation: https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/download-cloudwatch-agent-commandline.html#download-CloudWatch-Agent-on-EC2-Instance-commandline-first

- Verify that the Amazon CloudWatch agent was successfully downloaded using the following command and verify that it returns `True`:

```sh
Test-Path -Path $env:USERPROFILE\Desktop\amazon-cloudwatch-agent.msi
```

- Install the CloudWatch agent using the following PowerShell command. The command will execute silently and will install the agent on the EC2 instance

```sh
msiexec /i $env:USERPROFILE\Desktop\amazon-cloudwatch-agent.msi
```


3. **Create a configuration file**: Create a JSON configuration file using the wizard.

To generate the configuration file, we need to execute a file named `amazon-cloudwatch-agent-config-wizard.exe`. The executable program is menu-driven and will provide configurable options within your PowerShell console session. The executable will create a `config.json` file and also provides you with the option to store the configuration file in AWS Systems Manager Parameter Store.

- Navigate to `%ProgramFiles%\Amazon\AmazonCloudWatchAgent`, launch PowerShell, and run the `amazon-cloudwatch-agent-config-wizard.exe` executable using PowerShell, which will help you generate the configuration file with the options for gathering additional metrics from the operating system by executing the following code snippet (make sure to navigate to the path `%programfiles%\Amazon\AmazonCloudWatchAgent`. This is the path where the config.json file should be stored to execute the exercise correctly):

```sh
& $env:ProgramFiles\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent-config-wizard.exe
```

- The first question asks you which OS you would like to install the agent for. As we are on Windows EC2, we simply press `Enter` as it is the default option.

- The second question, asks for the location of the instance. The CloudWatch agent wizard will query the EC2 instance metadata to check the details and provide the default option. As we are using an EC2 instance on AWS, let’s proceed with the default selection.

- The third question, is about enabling the `StatsD` plugin. We will not configure the plugin for this exercise as there are no additional application requirements. Let’s provide option 2.

- The fourth question is about the migration of any legacy agent configuration from the old CloudWatch Log Agent. CloudWatch Log Agent was a standalone agent before the introduction of a unified CloudWatch agent. Let’s continue with option 2 as we are not transitioning any configuration from the legacy agent

- The next four questions, are about what type of metrics you would like to gather from the OS and the metric dimensions. We will go with the default options. Note that adding dimensions to the metrics will result in additional costs for CloudWatch metrics. Therefore, if specific metric dimensions are not required, it can be changed to `no`

![configure-agent](/imgs/configure-agent.png)

- The next question is about the resolution of the metrics. Based on the criticality of the application, you can gather metrics at a frequency of 1 second. For this exercise, we’ll select `1s` (1 second)

- The next question is about the additional metrics that you would like to gather by default. To make it easy, CloudWatch has predefined metrics for each configuration. The standard option will provide `Memory`, `Paging`, `Processor`, `PhysicalDisk`, and `LogicalDisk` information. Details can be verified at this link: https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/create-cloudwatch-agent-configuration-file-wizard.html. Refer to the `CloudWatch agent predefined metric sets` section. For this exercise, we are going with option 2 (`Standard`)

- The next question is about confirming whether the configuration is fine or whether you would like to change it. The configuration generated as a JSON file can be customized at a later stage if required. We will confirm that the configuration is good.

- The next four questions are about the logs that you would like to collect using the CloudWatch agent. We are going to collect IIS logs from the default path. We will select yes and provide the log path and the log group name to ingest the logs.

- Next, you will need to provide the log file path to gather the IIS log files, as shown here:

```sh
C:\inetpub\logs\LogFiles\W3SVC1\*.log
```

- We will be providing the name `IISLogs` as the log group name to store the logs sent by the CloudWatch agent for IIS:

```sh
IISLogs
```

- `Log Group Retention in days`: We will select option 5, which will set up the retention of logs for 7 days in the CloudWatch log group and specify any additional log files to monitor as `no`.

- The next question is whether you would like to monitor any Windows event logs. This will be useful if you would like to gather OS or application events (such as ad hoc OS reboots, application backup-related events, etc.). We will select `no` for this exercise.

- The configuration file will be saved locally. If you would like to automate the agent installation and configuration in the future, the config file can be saved to the `AWS SSM Parameter Store`. Let’s go ahead and save it in Parameter Store so that we can look at automation for the next exercise. Select the default options for the next four questions. In these four options, we are providing the name for the parameter store, which will default to `AmazonCloudWatch-windows`, the region to store the configuration file in (AWS System Manager defaults to the region you are building the EC2 instance in), and the credentials to access Parameter Store (provided by the AWS IAM role attached to the EC2 instance provided in step 1).


4. **Start the agent**: Start the CloudWatch agent using the configuration file.

We need to run a PowerShell command to start the agent along with the configuration file generated as part of step 3 to start the CloudWatch agent. Let’s proceed with starting the agent:

- Let’s start the agent using amazon-cloudwatch-agent-ctl.ps1 and using the configuration file generated in step 3 by running the following command:

```sh
& $env:ProgramFiles\Amazon\AmazonCloudWatchAgent\amazon-cloudwatch-agent-ctl.ps1 -a fetch-config -m ec2 -c file:$env:ProgramFiles\Amazon\AmazonCloudWatchAgent\config.json -s
```

> Documentation: https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/install-CloudWatch-Agent-commandline-fleet.html#start-CloudWatch-Agent-EC2-commands-fleet

- After running the command, you should see that the CloudWatch agent has been successfully started using the configuration file provided

![agent-start](/imgs/agent-start.png)

- You can check that the service has been successfully started and is running from `Services (Local)` in the Windows OS

![agent-running](/imgs/agent-running.png)

5. **Explore the data**: Next, let’s explore the data received by the CloudWatch metrics and logs from the CloudWatch agent:

- Navigate to `CloudWatch –> Metrics –> All metrics` and observe that there is a new custom namespace created with the name `CWAgent`

![cw-agent](/imgs/cw-agent.png)

- Click on the `CWAgent` metric namespace, then select `InstanceID`, which will provide the detailed metrics gathered for the EC2 instance, such as `Processor % Usertime`, `Physical % Disk Time`, `Pagefile Usage`, `MemoryCommitted`, and so on.

![instanceid](/imgs/instanceid.png)

- Browse the public IP of the EC2 instance created, which will generate the IIS logs. 

![webserver](/imgs/webserver.png)

- To verify the logs gathered, navigate to `CloudWatch | Log groups`. You should see that there’s a new log group named `IISLogs`.

![iislogs](/imgs/iislogs.png)

When you navigate the log group, you will observe the log streams in the CloudWatch Log groups that have been created by the instance ID for each EC2 instance.

This verifies that the manual agent installation was successful and we are able to succesfully gather additional metrics from the EC2 instance, in addition to collecting logs from the web server.

As a part of `Well-Architected` best practices, it would be good to leverage an automated agent rollout rather than a manual installation. We already generated the configuration file required for the configuration from the manual installation and stored it in AWS SSM Parameter Store. Let’s continue with the installation and configuration of the CloudWatch agent using AWS Systems Manager.